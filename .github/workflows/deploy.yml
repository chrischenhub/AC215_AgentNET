name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-images:
    name: Build & Push Images
    runs-on: ubuntu-latest
    env:
      GOOGLE_CREDENTIALS: ${{ secrets.GCP_CREDENTIALS }}
      # Pulumi backend bucket (derived from project ID)
      PULUMI_BUCKET: gs://charlesproject-471117-pulumi-state-bucket
      PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install Pulumi
        uses: pulumi/actions@v5

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: charlesproject-471117

      - name: Configure Docker auth for Artifact Registry
        run: |
          gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

      - name: Pulumi Login (GCS)
        # Login to the GCS bucket for state
        run: pulumi login ${{ env.PULUMI_BUCKET }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install uv
          python -m pip install -r src/deployment/deploy_images/requirements.txt || true
      
      - name: Setup Workspace Symlink
        run: |
          sudo rm -rf /workspace
          sudo ln -s ${{ github.workspace }}/src /workspace

      - name: Pulumi Up (Images)
        working-directory: src/deployment/deploy_images
        run: pulumi up -s dev -y
        
  deploy-k8s:
    name: Deploy to K8s
    needs: deploy-images
    runs-on: ubuntu-latest
    env:
      GOOGLE_CREDENTIALS: ${{ secrets.GCP_CREDENTIALS }}
      PULUMI_BUCKET: gs://charlesproject-471117-pulumi-state-bucket
      PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Pulumi
        uses: pulumi/actions@v5

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Set up gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: charlesproject-471117

      - name: Install GKE auth plugin (and kubectl)
        run: |
          gcloud components install gke-gcloud-auth-plugin kubectl --quiet

      - name: Pulumi Login (GCS)
        run: pulumi login ${{ env.PULUMI_BUCKET }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install uv

      - name: Pulumi Up (K8s)
        working-directory: src/deployment/deploy_k8s
        env:
          USE_GKE_GCLOUD_AUTH_PLUGIN: "True"
        run: pulumi up -s dev -y
