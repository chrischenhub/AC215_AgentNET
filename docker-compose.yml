version: "3.9"

services:
  postgres:
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_DB: agentnet
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: mySecurePassword123
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./DB/schema.sql:/docker-entrypoint-initdb.d/schema.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Main dev container for your app/tools (hot reload via bind mount)
  agentnet:
    build: .
    image: agentnet-cli:latest
    working_dir: /app
    # Load secrets/tokens
    env_file:
      - ./.env
    # Bind-mount the WHOLE repo so Python edits are visible immediately inside the container
    volumes:
      - ./:/app
      # Keep your persistent Chroma store mount too (still points inside /app)
      - ./DB/chroma_store:/app/DB/chroma_store
    entrypoint: ["/usr/local/bin/docker-entrypoint.sh"]
    command: ["/bin/bash"]   # drop into a shell; override per-run as needed
    tty: true
    stdin_open: true
    depends_on:
      postgres:
        condition: service_healthy

  # Convenience runner JUST for the Notion agent script.
  # Same image, same bind mount and env, but a default command to run the agent.
  # You can override the command at runtime with your own prompt.
  notion-agent:
    image: agentnet-cli:latest
    working_dir: /app
    env_file:
      - ./.env
    volumes:
      - ./:/app
    entrypoint: ["/usr/local/bin/docker-entrypoint.sh"]
    # Default command is a harmless help hint; you'll override this when running.
    command: ["python", "notion_agent.py", "--help"]
    tty: true
    stdin_open: true
    depends_on:
      postgres:
        condition: service_healthy

volumes:
  postgres_data:
