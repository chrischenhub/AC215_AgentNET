x-agentnet-image: &agentnet-image ${AGENTNET_IMAGE:-agentnet-cli}:${AGENTNET_IMAGE_TAG:-latest}
x-agentnet-base: &agentnet-base
  image: *agentnet-image
  platform: ${AGENTNET_PLATFORM:-linux/amd64}
  working_dir: /app
  volumes:
    - ./:/app
  entrypoint: ["/usr/local/bin/docker-entrypoint.sh"]
  tty: true
  stdin_open: true

services:
  postgres:
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_DB: agentnet
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: mySecurePassword123
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./DB/schema.sql:/docker-entrypoint-initdb.d/schema.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d agentnet"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  agentnet:
    <<: *agentnet-base
    build:
      context: .
    env_file:
      - .env
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./:/app
      - ./DB/chroma_store:/app/DB/chroma_store
    environment:
      DATABASE_URL: postgresql://postgres:mySecurePassword123@postgres:5432/agentnet
    command: ["sleep", "infinity"]
    restart: unless-stopped

  notion-agent:
    <<: *agentnet-base
    build:
      context: .
    env_file:
      - .env
    profiles: ["notion"]
    command: ["python", "notion_agent.py", "--help"]

volumes:
  postgres_data:
