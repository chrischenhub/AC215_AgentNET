x-agentnet-image: &agentnet-image ${AGENTNET_IMAGE:-agentnet-cli}:${AGENTNET_IMAGE_TAG:-latest}
x-agentnet-base: &agentnet-base
  image: *agentnet-image
  platform: ${AGENTNET_PLATFORM:-linux/amd64}
  working_dir: /app
  volumes:
    - ../..:/app
  entrypoint: ["/usr/local/bin/docker-entrypoint.sh"]
  environment:
    PYTHONPATH: /app/src/models:/app
    GCS_BUCKET_NAME: ${GCS_BUCKET_NAME:-agentnet215}
    GCS_DATA_DIR: ${GCS_DATA_DIR:-mcp_data_json}
    GCS_CHROMA_DIR: ${GCS_CHROMA_DIR:-chroma_store}
  tty: true
  stdin_open: true

services:
  agentnet:
    <<: *agentnet-base
    build:
      context: ..
      dockerfile: models/Dockerfile
    env_file:
      - .env
    cap_add:
      - SYS_ADMIN
    devices:
      - /dev/fuse
    security_opt:
      - apparmor:unconfined
    volumes:
      - ../..:/app
    ports:
      - "${AGENTNET_WEB_PORT:-8000}:8000"
    environment:
      PORT: 8000
      FRONTEND_ORIGINS: ${FRONTEND_ORIGINS:-http://localhost:8080,http://127.0.0.1:8080}
    command:
      [
        "uvicorn",
        "app:app",
        "--host",
        "0.0.0.0",
        "--port",
        "8000",
        "--reload",
        "--app-dir",
        "src/models",
      ]
    restart: unless-stopped

  notion-agent:
    <<: *agentnet-base
    build:
      context: ..
      dockerfile: models/Dockerfile
    env_file:
      - .env
    cap_add:
      - SYS_ADMIN
    devices:
      - /dev/fuse
    security_opt:
      - apparmor:unconfined
    profiles: ["notion"]
    command: ["python", "-m", "notion_agent", "--help"]

  frontend:
    build:
      context: ../frontend-simple
      dockerfile: Dockerfile
    image: ${AGENTNET_FRONTEND_IMAGE:-agentnet-frontend:latest}
    platform: ${AGENTNET_PLATFORM:-linux/amd64}
    environment:
      PORT: ${AGENTNET_FRONTEND_PORT:-8080}
      API_BASE_URL: ${AGENTNET_API_BASE_URL:-http://localhost:8000/api}
    ports:
      - "${AGENTNET_FRONTEND_PORT:-8080}:${AGENTNET_FRONTEND_PORT:-8080}"
    depends_on:
      - agentnet
    restart: unless-stopped
